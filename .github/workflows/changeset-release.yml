---
name: Changeset Release

# yamllint disable rule:truthy
on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions: read-all

jobs:
  release:
    # IMPORTANT: prevent this action from running on forks
    if: github.repository == 'chizmw/changesets-changelog-info'
    permissions:
      contents: write # to create release (changesets/action)
      pull-requests: write # to create pull request (changesets/action)
    name: Changeset Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CHANGESETS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: yarn

      - name: Create Release Pull Request
        id: changesets
        uses: changesets/action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.CHANGESETS_TOKEN }}
        with:
          title: Release Changeset (bake CHANGELOG.md)

      # we use ourself to get the information for the release
      - name: Get Change Info
        uses: ./
        id: get-changelog-info

      - name: Extract branch name
        id: extract-branch
        shell: bash
        # yamllint disable-line rule:line-length
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

      - name: Update Version In Files
        # https://github.com/changesets/action#custom-publishing
        if: steps.changesets.outputs.hasChangesets == 'false'
        shell: bash
        # yamllint disable rule:line-length
        run: |
          latest_version="${{ steps.get-changelog-info.outputs.last-change-version }}"
          files="README.md"

          # replace the version "latest-v0.0.4-blue" with the latest
          sed -i "s/latest-v.*-blue/latest-${latest_version}-blue/g" $files

          # update any doc references to ourself; chizmw/changesets-changelog-info@v0.0.4
          sed -i "s/chizmw\/changesets-changelog-info@v.*/chizmw\/changesets-changelog-info@${latest_version}/g" $files

          # commit and push the changes
          git config --global --add --bool push.autoSetupRemote true
          git add $files
          git commit -m "chore: update version in files (${{ steps.get-changelog-info.outputs.last-change-version}})"
          git push
        # yamllint enable rule:line-length

      - name: Push Tags
        # https://github.com/changesets/action#custom-publishing
        if: steps.changesets.outputs.hasChangesets == 'false'
        shell: bash
        run: |
          git tag ${{ steps.get-changelog-info.outputs.last-change-version }}
          # this could fail in a merge without changesets
          # (e.g. update README.md, merge)
          # but that's a bit naughty anyway, so we'll let it fail
          git push --tags
